<template id="art-palette">
    <style>
        @import "/modules/wwi/component/design/host.css";
        sticky-list{
	        display: inline-block;
	        width: 300px;
	        top:1px;
	        height:calc(100% - 1px);
	        background:white;
	        --header-shadow:clear;
	        --header-fixed-width:100%;
	        --header-title-left:0px;
	        --header-radius:0;
	        --header-height:34px;
	        --header-back:white;
	        --header-fixed-shadow:drop-shadow(-6px 0 10px rgba(0,0,0,0.4));
	        --header-fixed-y:translateY(0);
        }
	    wwe-position{
		    height:200px;
	    }
	    [value]{
		    display:block;
		    position:relative;
		    background-color: white;
	    }
	    canvas{
		    position:relative;
		    box-sizing:border-box;
		    overflow: hidden;
	    }

    </style>
	<sticky-list multi id="colors"></sticky-list>
	<wwe-position offset-y="80px" offset-x="300px" no-title>
		<canvas preview width="200" height="200"></canvas>
	</wwe-position>
</template>
<script>
    (function(doc){
        const ArtPalette = wwi.element(doc).extension({name:'Palette',module:'behavior'})
        ArtPalette(class extends ArtPalette.Element{
        	constructor(){
        		super('routes',{
        			url(value){
        				if(value !== null) this.palette = value
			        }
		        })
	        }
	        get box(){ return this.query('wwe-position') }

	        connected(){
		        this.list.on('items',on_items)
	        	this.on('palette items',e=>{
	        		let items = e.detail
			        this.list.set_items(...items)
		        })
		        if(!this.url) this.palette = fxy.require('design/colors')


		        let timeout_id = null
		        this.list.item_selected = e=>{
		        	if(typeof timeout_id === 'number') timeout_id = window.clearTimeout(timeout_id)
			        window.requestAnimationFrame(()=>{
				        timeout_id = setTimeout(()=>{
					        this.on_selections(this.list.selector.selected,e)
				        })
			        })
		        }


	        }
	        on_selections(selected,e){
	        	let target = e.currentTarget
	        	let colors = this.current_colors || []
		        let selected_colors = selected.map(item=>item.data.value)

		        colors = colors.filter(color=>selected_colors.includes(color))
		        for(let color of selected_colors){
	        		if(!colors.includes(color)) colors.push(color)
		        }
		        this.current_colors = colors
		        this.box.present(e)
		        gradient(this.preview,colors)
	        }

	        get list(){ return this.query('sticky-list') }


	        get palette_options(){ return {number_of_items:3} }
	        get preview(){ return this.query('canvas[preview]') }
        })

		//shared actions
	    function on_items(e){
		    for(let item of e.detail) item.background = item.data.value
	    }
	    function gradient(canvas,colors){
		    var ctx = canvas.getContext('2d')
		    let width = 200
		    var g1 = ctx.createLinearGradient(0, 0, width, 0);

		    let increment = 1/colors.length
		    for(let i=0;i<colors.length;i++){
		    	let color = colors[i]
			    let position = i * increment
			    g1.addColorStop(position,color);
		    }
//		    g1.addColorStop(0,"magenta");
//		    g1.addColorStop(0.5,"yellow");
//		    g1.addColorStop(1,"black");
//		    ctx.fillStyle = g1;
//		    ctx.strokeStyle = "red";
//		    ctx.lineWidth = 10;
//		    ctx.fillRect(0, 0, 50, 50);
//		    ctx.strokeRect(0, 0, 50, 50);

//		    var g2 = ctx.createRadialGradient(350, 100, 0, 350, 100, 200);
//		    g2.addColorStop(0,"magenta");
//		    g2.addColorStop(0.5,"yellow");
//		    g2.addColorStop(1,"black");
//		    ctx.fillStyle = g2;
//		    ctx.fillRect(250,0,200,200);
//		    ctx.strokeRect(250,0,200,200);

		    var pattern = ctx.createPattern(canvas, "repeat");
		    ctx.fillStyle = pattern;
		    ctx.fillRect(0,0,width,width);
		    ctx.lineWidth = 20;
		    ctx.strokeStyle = g1;
		    ctx.strokeRect(0,0,width,width);
		    ctx.fill();
		    return pattern
	    }

    })(document)
</script>
