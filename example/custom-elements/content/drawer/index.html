<template id="content-drawer-template">
	<style>
		:host{
			--content-drawer-width:333px;
			--content-drawer-z:100;
			--shadow-color:rgba(0,0,0,0.2);

			bottom:0;
			top:0;
			box-sizing: border-box;

			cursor: default;
			outline:none;
			position: absolute;

			transform: translate3d(0,0,0);
			transition-property: transform;
			transition-duration: 200ms;
			transition-timing-function: ease-in-out;
			transform-style: preserve-3d;

			-webkit-user-select: none;  -moz-user-select: none;  -ms-user-select: none;  user-select: none;

			width: 300px;
			will-change: transform;

			z-index: 9;
			display: none;
			pointer-events: none;
			opacity: 0;
		}

		:host([is-transitioning]){  -webkit-backface-visibility: visible;  backface-visibility: visible;  }

		:host([is-app-drawer]){
			height:100%;
			min-height: 100%;
			max-height: 100%;
			position:fixed;
		}

		:host(.show){
			display: block;
			opacity: 1;
			z-index: 10;
		}

		:host([opened]){ pointer-events: auto; }

		#container{
			box-sizing: border-box;
			display: block;

			height: 100%;

			max-height: 100%;
			max-width: 100%;

			overflow: hidden;
			overflow-y: auto;

			position: relative;

			width: 100%;
		}

		#container::-webkit-scrollbar {
			height: 13px;
			overflow: visible;
			width: 13px;
		}

		#container::-webkit-scrollbar-button { height: 0;  width: 0; }

		#container::-webkit-scrollbar-corner {
			background: rgba(0, 0, 0, 0);
		}

		#container::-webkit-scrollbar-thumb {
			background-color: rgba(255,255,255,.72);
			background-clip: padding-box;
			border: solid rgba(0, 0, 0, 0);
			min-height: 28px;
			padding: 100px 0 0;
			border-radius: 100px;
			box-shadow: inset 0 0 0 1px rgba(255,255,255,.1), inset 1px 1px 0 rgba(0,0,0,.1), inset -1px -1px 0 rgba(0,0,0,.1);

		}

		#container::-webkit-scrollbar-track {
			background-clip: padding-box;
			border: solid rgba(0, 0, 0, 0);
			border-width: 0 0 0 4px;
		}

		#container::-webkit-scrollbar-track-piece {
			background-clip: padding-box;
			background-color: rgba(245, 245, 245, 0);
			border: solid rgba(245, 245, 245, 0);
			border-width: 0 0 0 3px;
		}

		#containerContent::slotted(*){
			box-sizing: border-box;
		}

		#contentTitle::slotted(*){
			background-color: rgba(233,235,246,0.56);

			border-radius: 4px 4px 0 0;

			color:white;

			-webkit-filter: drop-shadow(0px 0px 8px rgba(0,0,0,0.15)) contrast(120%);
			filter: drop-shadow(0px 0px 8px rgba(0,0,0,0.15)) contrast(120%);

			font-weight:900;
			font-size:20px;

			padding:18px;

			text-shadow:0 0 8px rgba(40,40,60,0.15);

			text-transform: capitalize;
		}

		:host-context([page="banks"]) #contentTitle::slotted(*){
			color:#706A78;
		}

		#close{
			-webkit-appearance:none;
			background-color:transparent;
			border-radius: 100px;

			width: 25px;
			height: 25px;
			position: absolute;

			top:2px;
			right:2px;
			box-sizing: border-box;
			border:1px solid transparent;
			color:var(--berry);
			text-shadow:0 0 8px rgba(40,40,60,0.15);
			outline:none;
			z-index: 100;
			cursor: pointer;
			transition:opacity 180ms ease;
			will-change:opacity;
		}

		#close [arrow]{
			font-size:18px;
			text-align:center;
			position:absolute;
			top:1px;left:0;right:0;bottom:0;
		}

		:host([right]) #close{
			transform: rotate(180deg);
		}


		#close:hover,
		#close:focus{
			border-color: white;
			-webkit-filter: drop-shadow(0px 0px 3px rgba(0,0,0,0.1)) contrast(120%);
			filter: drop-shadow(0px 0px 3px rgba(0,0,0,0.1)) contrast(120%);
			background-color: rgba(255,100,100,1);
			color:white;
		}

		:host([hidden-close-button]) #close{
			opacity: 0;
		}
		:host([hidden-close-button]) #container:hover #close{
			opacity:0.5;
		}
		:host([hidden-close-button]) #close:focus{
			opacity:1;
		}




		:host([is-app-drawer].show){
			z-index: var(--content-drawer-z);
		}

		:host([is-app-drawer]){
			top:32px;
			min-height:calc(100vh - 112px);
			max-height:calc(100vh - 112px);
			width: var(--content-drawer-width);
		}

		[moves-for-content-drawer]{
			max-width: 100vw;
			transition: max-width 180ms ease-in-out, transform 200ms ease-in-out;
			transform-style: preserve-3d;
			transform:translate3d(0,0,0);
			transform-origin: center left;
			will-change: max-width, transform;
		}

		:host([content-drawer-opened]) [moves-for-content-drawer]{
			max-width: calc( 100vw - var(--content-drawer-width,333px) );
			transform: translate3d( var(--content-drawer-width,333px), 0,0 );
		}

		:host([left]){
			transform:translate3d(-300px,0,0);
			left:0;
		}

		:host([left])::before{
			content:'';
			position: absolute;
			top:0;
			left:0;
			right:0;
			bottom:0;
			box-shadow: 1px 3px 5px -1px var(--shadow-color);
		}

		:host([right]){
			right:0;
			transform:translate3d(300px,0,0);
			left:initial;
		}

		:host([right])::before{
			content:'';
			position: absolute;
			top:0;
			left:0;
			right:0;
			bottom:0;
			box-shadow: -1px 3px 5px -1px var(--shadow-color);
		}

		[name="bg"]::slotted(*){
			display: block !important;
			position: absolute !important;
			height: 100%;
			left:0;
			top:0;
			width:100%;
			z-index: 0;
			overflow: hidden;
		}

	</style>


	<div id="container">
		<slot name="bg"></slot>
		<slot id="contentTitle" name="title"></slot>
		<slot id="containerContent" name="content"></slot>
		<button tabindex="0" aria-label="Collapse menu" title="Collapse menu" role="button" id="close">
			<div arrow gui fit>&leftarrow;</div>
		</button>
	</div>


</template>
<script id="content-drawer">
	((doc)=>{

//		const AppDrawer = Symbol.for('AppDrawer')
		const Drawer = wwi.element(doc)
		const body_has_drawer_event = Symbol('body has drawer event')

		const DrawerSides = {
			names: ['top', 'right', 'bottom', 'left'],
			clear(element){
				this.names.forEach(name=>element.classList.toggle(name, false))
				return this
			},
			get(side){ return this.names.filter( name => side.includes(name) ) },
			set(side, element){
				side = typeof side === 'string' ? side.toLowerCase().trim() : ''
				return this.clear(element).get(side).map(function (name) { this.classList.toggle(name, true); return name }, element);
			}
		}

		const DrawerMix = Base => class extends Base {
//			get app() {return window.app.el }

			get container() {return this.shadowRoot.querySelector('#container')}
			get content(){ return this.slots.content.target }

			set_tabindex(active){
				let tabindex = active ? '0':'-1'
				let content = this.content
				if(content){
					if('set_tabindex' in content) content.set_tabindex(active)
					content.style.pointerEvents = active ? 'auto':'none'
					content.setAttribute('aria-disabled',active ? 'false':'true')
				}

				return this
			}
			open() {
				this.setAttribute('is-transitioning', '')
				this.classList.toggle('show', true)
				this.set_tabindex(true).setAttribute('opened','')

				setTimeout(() => {
					this.style.transform = 'translate3d(0,0,0)'
				},100)
				return this
			}

			close() {
				this.set_tabindex(false).setAttribute('is-transitioning', '')
				this.style.transform = this.hasAttribute('right') ? 'translate3d(100%,0,0)':'translate3d(-100%,0,0)'
				this.removeAttribute('opened')
				return this
			}

			transition_ended(e) {
				if (!this.hasAttribute('opened')) this.classList.toggle('show', false)
				this.removeAttribute('is-transitioning')
				this.dispatch('transition',{opened:this.opened, get closed(){ return !this.opened }})
			}

//			connect_drawer() {
//				if (this.isAppDrawer) {
//					this.appDrawerCallback = this.appDrawerCallback ? this.appDrawerCallback : app_drawer_callback.bind(this)
//					if (!this.hasAppDrawerCallback) this.hasAppDrawerCallback = true; window.addEventListener('app-drawer', this.appDrawerCallback.bind(this), false)
//				}
//				return this
//			}
		}


		Drawer(class extends DrawerMix(Drawer.Element){
			constructor(){ super() }
			changed(name,old,value){
				switch (name) {
					case 'side':
						this.sides = DrawerSides.set(value, this);
						this.style.transform = this.closed_transform
						break
					case 'app':
						if(value !== null){
							if(!(body_has_drawer_event in window.document.body)){
								window.document.body[body_has_drawer_event] = true
								window.document.body.addEventListener('mousedown',body_mouse_down.bind(this),false)
							}
						}
						break
				}
			}
			connected(){
				this.define({ side:true, app:true })
				this.addEventListener('transitionend', this.transition_ended.bind(this), false)
				this.close_button.onclick = e => this.close()
//				    .addEventListener('click', function (e) { this.close() }.bind(this), false)
				this.addEventListener('mousedown',prevent_mouse_down,false)
			}
			get close_button(){ return this.container.querySelector('button#close') }
			toggle(){
				if(this.opened) this.opened=false
				else this.opened = true
				return this
			}
			get opened(){ return this.hasAttribute('opened') }
			set opened(value){
				if(value) this.open()
				else this.close()
				return value
			}
		})


		function prevent_mouse_down(e){
			if(e.stopPropagation) e.stopPropagation()
			if(e.preventDefault) e.preventDefault()
			return false
		}

		function body_mouse_down(e){
			if(this.opened) {

				this.opened = prevent_mouse_down(e)
			}
		}

		function app_drawer_callback(e){
			if (e && e.detail) {
				if (e.detail.open) this.opened = true
				else if (e.detail.close) this.opened = false
			}
		}

	})(document)
</script>
