<link rel="import" href="panel.html">
<link rel="import" href="list.html">
<template id="tabs-view-template">
	<style>
		@import "../modules/wwi/component/design/host.css";
		:host {
			--list-height:33px;
			display: block;
			position: relative;
		}
		[view]{
			position: relative;
			height:100%;
			width:100%;
		}
		[panels]{
			position:relative;
			height:calc(100% - var(--list-height));
			width: 100%;
			background-color: rgba(255,255,255,0.4);
		}

	</style>
	<div view gui horizontal wrap>
		<tab-list gui horizontal around-justified end stretch>
			<slot id="tabs" name="tab"></slot>
		</tab-list>
		<div panels gui horizontal center-center>
			<slot name="panel">
				Tab Panels
			</slot>
		</div>
	</div>

</template>
<script>
	(function (doc) {
		var Tabs = wwi.element(doc)
		app.port.eval(url.elements('tabs/sort.es6')).then(SortModule=>{
			let Sort = SortModule()
			Tabs(class extends Tabs.Element{
				get list(){ return this.query('tab-list') }


				connected(){
					this.sort = new Sort(this,this.list)
					this.list.panel = this.panel
				}
				deselect(tab){
					if(tab instanceof HTMLElement){
						tab.aria.selected=false
						let panel = tab.panel
						if(panel) panel.active = false
					}
					return  this.resize_panels()
				}
				on_sort(){

					let tabs = this.tabs
					tabs.forEach((tab,index)=>{
						tab.panel.dataset.index = index
					})

					let panels = this.panels.sort((A,B)=>{
						let a = parseInt(A.dataset.index)
						let b = parseInt(B.dataset.index)
						if(a > b) return 1
						if(b < a) return -1
						return 0
					})

					panels.forEach(panel=>panel.remove())
					panels.forEach(panel=>{ this.append(panel) })
					this.tabs.forEach(tab=>{

						if(tab.was_selected) {
							this.deselect(tab)
							this.select(tab)
						}
						delete tab.was_selected
					})
				}
				panel(id){
					return this.panels.filter(panel=>{
							console.log(panel.id)
							return panel.id === id
						})[0] || null
				}
				get panels_slot(){ return this.query('slot[name="panel"]') }
				get panels(){
					let slot = this.panels_slot
					if(slot) {
						let nodes = Array.from(slot.assignedNodes())
						return nodes.filter(node=>node instanceof HTMLElement)
					}
					return []
				}
				resize_panels(){
					let tabs = this.tabs
					tabs.forEach(tab=>{
						let panel = tab.panel
						panel.style.width = tab.size.width+'px'
						if(panel.update) {
							setTimeout(()=>{ panel.update() },200)
						}
					})
					return this
				}
				select(tab){
					if(tab.aria.selected === 'true') return this.deselect(tab)
					tab.aria.selected = true
					let panel = tab.panel
					if(panel) panel.active = true
					return this.resize_panels()
				}
				get tabs(){ return this.list.tabs }

			})
		})


	})(document)
</script>