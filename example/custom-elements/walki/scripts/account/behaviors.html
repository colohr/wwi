
<script>
	'use strict';
	(function(window){
		var document = window.document;
		const AccountTapActions = {
			current:'login',
			list:{
				'login':'Login',
				'create':'Create Account',
				'update':'Update',
				'any':'Ok',
				'logout':'Logout',
				'relogin':'Re-Login'
			}
		}
		const AccountProperties = {
			provider:{type:Object},
			isUserAccount:{ type:String, reflectToAttribute:true,  value:true },
			actions:{ type:Object,  value(){ return AccountTapActions; } },
			user:{ type:Object,  value(){ return new KindlePublishingUser(this); } },
			popoverAccount:Object,
			auth:Object
		}
		const AccountActions = {
			msgAction(){},
			tapAction(){}
		}

		const Editable = {
			properties:{
				editing:{type:Object,value:false,reflectToAttribute:true,observer:'onEditing'}
			},
			edit(){ this.editing = this.editing ? false:true; return this; }
		}

		const Shopbar = {
			get shopbar(){
				if(!this.Shopbar){
					if(document.querySelector('shop-bar') === null){
						this.Shopbar = document.createElement('shop-bar');
						document.body.appendChild(this.Shopbar);
					}else{
						this.Shopbar = document.querySelector('shop-bar');
					}
					this.Shopbar.logoHTML = `
						<div style="width:41px"></div>
						<div id="logo" style="height:51px;width:51px;left:7px;position:absolute;overflow:hidden;border-radius:100px;box-sizing:border-box;background-image:url(/images/shop/icon.png);background-repeat:none;background-position:center center;background-size:101% auto;"></div>
					`
					this.listen(this.Shopbar,'message','onMessage');
				}
				return this.Shopbar;
			},
			attached(){
				window.addEventListener('shop',(e)=>{
					if(!this.user.isContext) return;
					var detail = e.detail;
					var action = detail.action;
					var shopper = this.shopbar.shopper || this.user.shopper;
					var button = {message:undefined,title:false,duration:undefined,action:undefined};
					switch(action){
						case 'item':
							shopper.bundle.items.push(detail.item);
							if(!shopper || this.shopbar.shopper !== shopper) this.shopbar.update(shopper);
						    else this.shopbar.update()

							break;
					}
					if(button.msg && this.Msg) this.Msg(button.msg,button.title,button.duration,button.action);
				});
			}
		}

		const Message = {
			listeners:{'message':'onMessageHandler'},
			msgAction(e,data){
				var button = data.button;
				switch(button){
					case 'Switch to create account':
						this.select('Create')
						break;
				}
			},
			errMsg(error){
				if(error.code === 'auth/requires-recent-login'){
					if(this.provider && this.provider.providerId === 'password'){
						this.$.submit.current = 'relogin';
						this.$.password.show().focus();
					}
					this.Msg('This action requires a recent session to continue.','Re-login to change account',null,function(action){
						if(action === 'open'){
							if(this.provider && this.provider.providerId === 'password'){
								this.$.password.show().focus();
							}
						}
						else if(action === 'close'){
							var e = {currentTarget:{current:'reauthenticate'}}
							if(this.provider && this.provider.providerId !== 'password'){
								this.tapAction(e);
							}else if(this.provider && this.provider.providerId === 'password'){
								this.$.password.show();
							}
						}

					}.bind(this));
				}else this.Msg(error.message,false);
			},
			updateMsg(res){
				this.Msg('Profile Updated',false);
				if(this.onceEmailReady && this.user.email){
					this.onceEmailReady(this);
					delete this.onceEmailReady;
				}
			},
			attached(){
				if(window.document.body.querySelector('msg-bar') === null){
					this.msg = document.createElement('msg-bar')
					window.document.body.appendChild(this.msg);
					this.msg.id = 'msg';
					this.msg.onAction = this.msgAction.bind(this);
				}else{
					this.msg = window.document.body.querySelector('msg-bar');
				}
				MsgProperty(this,this.msg)
			},
			onMessage(event,e){
				var msg = e.detail;
				var showLogin = false;
				var message;
				if(msg.message){
					message = {}
					message.text = msg.message;
					message.button = msg.button || 'Ok';
					message.duration=msg.duration;
					message.method= msg.method;
				}
				if(msg.login){
					this.user.Context.onLogin = msg.login;
					showLogin = msg.login.target
				}else if(msg.account){ showLogin = msg.account.target; }
				else if(msg.email){
					showLogin = msg.email.target
					if(this.needContactEmail) this.needContactEmail(()=>{
						msg.email.changed(this);
					})
				}

				else if(msg.receipt){
					this.$.license.user=null;
					var shopper = this.user.destroy('shopper').shopper;
					shopper.bundle.clear();
					shopper.last = msg.receipt;
					this.shopbar.update(shopper);
					this.shopbar.hide();
					this.$.license.user=this.user;
				}
				if(message){
					this.Msg(message.text,message.button,message.duration,message.method)
				}
				if(showLogin){
					if(this.showLogin) {
						this.showLogin(showLogin)
						.then((popover)=>{
							console.log(popover,e)
						})
						.catch((err)=>{
							console.error(err);
						})
					}
				}
			}
		}


		window.Definite((app)=>{
			app.behavior('editable',Editable)
			app.behavior('shopbar',Shopbar)
			app.behavior('account',[
			   Editable,
			   Message,
				Shopbar,
				{
					properties:AccountProperties,
					showLogin(target){

						return new Promise((resolve,reject)=>{
							let popover = this.user.popover
							if(popover){
								popover.present(target)
								popover.position()
								return resolve(popover)
							}else{
								return reject({needsLogin:true})
							}
						})
					},
					attached(){
						this.auth = window.firebase.auth()
					}
				}
			])
		})
	})(window)
</script>