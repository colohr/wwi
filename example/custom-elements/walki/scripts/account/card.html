
<link rel="import" href="elements.html">



<dom-module id="kindle-publishing-account-card">
	<template>
		<style include="kindle-account-card-styles"></style>

		<div id="view" class="user-input-container">

			<div class="user">
				<div class="avatar" item-icon>
					<avatar-item id="avatars" item-icon></avatar-item>
				</div>
				<text-input type="text"
				            titled
				            id="displayName"
				            label="Name"
				            holder="Kindle Sparks Account"></text-input>
				<a aria-label="Edit Profile"
				   title="Edit Profile"

				   id="editLink"
				   on-tap="edit">
					<iron-icon icon="icons:settings"></iron-icon>
				</a>
			</div>

			<div class="account">
				<text-input id="email"

				            type="email" label="Email"
				            editing="[[editing]]"
				            holder='Choose login or "Create" to get started.'></text-input>
				<text-input type="password"

				            id="password"
				            label="Password"></text-input>
				<text-input type="text"

				            id="verify" label="Retype Password"></text-input>
			</div>

			<div class="providers">
				<div class="linked-title">
					Linked Accounts
				</div>
				<div id="linked"></div>
			</div>

			<div class="license">
				<kindle-account-license  id="license"></kindle-account-license>
			</div>

			<select-menu  id="menu">
				<select-option name="Google">
					<div class="option-container">
						<img src="/images/icon/provider/google.png">
						<span>Google</span>
					</div>
				</select-option>

				<select-option name="Facebook">
					<div class="option-container">
						<img src="/images/icon/provider/facebook.png">
						<span>Facebook</span>
					</div>
				</select-option>

				<select-option name="Twitter">
					<div class="option-container">
						<img src="/images/icon/provider/twitter.png">
						<span>Twitter</span>
					</div>
				</select-option>

				<select-option name="Email">
					<div class="option-container">
						<img src="/images/icon/provider/email.png">
						<span>Email</span>
					</div>
				</select-option>

				<select-option name="Create">
					<div class="option-container">
						<img src="/images/icon-sets/iconic/svg/sunny.svg">
						<span>Create</span>
					</div>
				</select-option>
			</select-menu>

			<tap-action  id="submit" on-tap="tapAction" no-shadow titles="[[actions.list]]" current="[[actions.current]]"></tap-action>

			<div class="buttons">
				<tap-action id="deleteButton"
				            danger
				            needs-verification
				            on-verification="deleteAction">
					<span slot="currentTitle">Delete Account</span>
					<div id="verification" class="verification message-layout" slot="verificationMessage">
						<div class="message-icon">
							<img class="message-image" src="/images/icon-sets/iconic/svg/garbage.svg">
						</div>
						<div class="message-text">
							Are you sure you want to delete this account?  This cannot be undone.
						</div>
					</div>
				</tap-action>
			</div>
		</div>
		<!--<avatar-picker id="avatars"></avatar-picker>-->
	</template>
	<script>
		'use strict';
		Definite((app,firebase)=>{
			Polymer({
				is: "kindle-publishing-account-card",
				hostAttributes:{
					'aria-label':'User Account Card',
					'aria-disabled':'true',
					'slot':'account'
				},
				behaviors:app.behavior('account'),
				properties:{
					isPopover:{type:Boolean,observer:'onIsPopover'}
				},

				get providers(){return this.user.providers},
				get menu(){ return this.$.menu; },
				get loggedIn(){ return this.user ? this.user.loggedIn:false; },
				get avatars(){
					if(!this[Symbol.for('avatars')]){
						var avs = document.querySelector('avatar-picker');
						if(avs === null){
							avs = document.createElement('avatar-picker');
							avs.setAttribute('id','avatars')
							document.body.appendChild(avs);
						}
						this[Symbol.for('avatars')] = avs
					}
					return this[Symbol.for('avatars')];
				},
				get avatar(){return this.avatars.avatar},
				onIsPopover(is){
					if(is){
						if(!this.$.menu.onDropdown){
							this.$.menu.onDropdown = ()=>{
								this.timer(()=>{
									this.dispatchEvent(new CustomEvent('resize',{bubbles:true}))
								})
							}
						}
					}
				},

				getProfileState(){ return this.profileState || this.user.profile; },
				onEditing(editing){
					if(this.loggedIn){
						if(editing){
							this.profileState = this.user.profile;
							this.$.submit.current = 'update';
							this.$.email.hold(false,false);
							this.$.displayName.hold(false,false);
						}else{
							delete this.profileState;
							this.updateUi();
						}
					}
				},
				deleteAction(e,verification){
					if(verification.accepted){
						this.user.Delete().then((res)=>{
							this.editing=false;
							if(!res || (res && !res.needsLogin)) this.Msg('Your account has been deleted.  For any further assistance please contact us at support@kindlepublishing.com thank you.',false);
						}).catch(this.errMsg.bind(this));
					}
					verification.hide();
				},
				select(key){
					key = Provider.getKey(key)
					if(key){
						this.menu.get(key)._tap();
						this.menu.toggle();
					}
				},
				updateUserProfile(){
					var displayName = this.$.displayName.valid ? this.$.displayName.value:undefined;
					var photoURL = this.avatar ? this.avatar.src:undefined;
					var email = this.$.email.valid ? this.$.email.value:undefined;

					var changes = {displayName,email,photoURL}
					var changed = this.user.getProfileChanges(this.getProfileState(),changes);
//					console.log({email},{changed})
					if(Object.keys(changed).length){
						return this.user.updateProfile(changed).then(()=>{
							if(changed.email){
								this.user.updateEmail(changed.email).then(()=>{
									this.updateMsg()
								}).catch(this.errMsg.bind(this))
							}else{
								this.updateMsg()
							}
						}).catch(this.errMsg.bind(this));
					}

				},
				needContactEmail(callback){
					this.onceEmailReady=callback;
					this.Msg('No email found in your provider account.','Update Email',Infinity,(type)=>{
						if(type === 'open'){
							this.edit()
							this.$.email.focus()
						}
						if(type === 'close'){
							if(this.$.email.valid){
								this.updateUserProfile()
							}
						}
					})
				},
				inputFocus(id){
					let element = id instanceof HTMLElement ? id:this.$[id];
					const focus = function focusEvent(){
						if(this.focus) return this.focus();
						return this;
					}
					return focus.bind(element);
				},
				popup(provider,Acct){
					let user = this.user;
					return new Promise((resolve)=> {
						return this.auth.signInWithPopup(provider).then((pop) => {
							if(this.accountLink){
								let linker = this.accountLink;
								let creds = linker.creds;
								if(creds){
									this.Msg(`You can enable your ${this.accountLink.name} account to use either one in the future.`,`Link ${this.accountLink.name}`,0,(type)=>{
										if(type === 'close'){
											user.Link(creds).then((res)=>{
												this.Msg('Your '+linker.name+' account is now linked',false);
											}).catch((err)=>{
												this.Msg(err.message,false);
											});
										}
									})
								}
								delete this.accountLink;
							}
							return resolve({pop})
						}).catch((err) => {
							let code = err.code
							if (code && code === 'auth/account-exists-with-different-credential') {
								let mail = err.email
								let accountLink = {
									error:err,
									email:mail,
									get creds(){ return this.error ? this.error.credential:null; },
									get name(){return this.creds ? this.creds.provider:null }
								};
								this.accountLink = accountLink;
								return this.auth.fetchProvidersForEmail(mail).then((list) => {
									if (list && list.length) {
										accountLink.list=list;
										this.accountLink = accountLink;
										let names = list.length === 1 ? list[0] : list.join(', ');
										this.Msg('You already have an account active using ' + mail + ' from ' + names, 'Switch to ' + list[0], 0, (type) => {
											if (type === 'close' && accountLink) {
												this.select(accountLink.list[0]);
												return this.popup(this.provider);
											}
										});
									} else this.Msg(err.message, false);
									return resolve({err,list,links:Array.isArray(list)});
								});
							} else{
								let m = err.message;
								var msg = null;
								if(m.includes('{')){
									try{
										var o = JSON.parse(m);
										if(o.error) msg = o.error.message.split(',')[0]+'. Click login to retry.';
									}catch(e){}
								}else msg = m;
								if(!msg) msg = 'An error occured. Click login to retry.'
								this.Msg(msg, false)
							};
							return resolve({error:err})
						});
					});
				},
				signOut(){
					let uid = this.user.uid;
					this.provider=null;
					this.providerSelected=null;

					return this.auth.signOut();
				},
				tapAction(e){
					var target = e.currentTarget
					var key = target.current
					var provider = this.provider
					if(this.providerSelected && !this.loggedIn || key === 'reauthenticate'){
						if(this.providerSelected) key = Provider.Id(this.providerSelected)
						if(!provider) provider = Provider.Provider(this.providerSelected)
					}

					switch(key){
						case 'logout':
							this.signOut();
							break;
						case 'update':
							this.updateUserProfile();
							break;
						case 'create':
						case 'password':
						case 'email':
						case 'relogin':
							if(this.$.email.valid){
								if(this.$.password.valid){
									if(key === 'email' || key === 'password' || key === 'relogin'){
										this.auth.signInWithEmailAndPassword(this.$.email.value,this.$.password.value).then((res)=>{
											this.Msg('Logged In!',false);
										}).catch(function(error) {
											var errorCode = error.code;
											var errorMessage = error.message;
											if(errorCode === "auth/user-not-found") this.Msg('This account does not exist.','Switch to create account');
											else this.Msg(errorMessage,false);
										}.bind(this));
									}else if(this.$.password.value === this.$.verify.value){
										var name = this.$.displayName.value;
										var photoURL = this.avatar ? this.avatar.src:undefined;

										this.auth.createUserWithEmailAndPassword(this.$.email.value,this.$.password.value).then((res)=>{
											this.Msg('Your account is ready!',false);
											if(name || photoURL) this.user.updateProfile({displayName:name,photoURL});
										}).catch(function(error) {
											// Handle Errors here.
											var errorCode = error.code;
											var errorMessage = error.message;
											if (errorCode == 'auth/weak-password') this.Msg('The password is too weak.',false);
											else this.Msg(errorMessage,false);
											console.error(error);
										}.bind(this));
									}
									else this.Msg('Please verify your password','Ok',false,this.inputFocus('verify'));
								}
								else this.Msg('Please enter a password','Ok',false,this.inputFocus('password'));
							}
							else this.Msg('Please enter your email','Ok',false,this.inputFocus('email'));

							break;
						default:
							if(provider) {
								this.popup(provider).then((data)=>{});
							}else{
								this.Msg('Choose a provider to continue','Show Me',null,(type)=>{
									if(type === 'close'){
										if(!this.menu.active) this.menu.toggle();
									}
								});
							}
							break;
					}
				},
				timer(cb){
					if(typeof timeoutEvent === 'number'){
						window.clearTimout(this.timeoutEvent)
						delete this.timeoutEvent
					}
					this.timeoutEvent = window.setTimeout(()=>{
						cb();
						delete this.timeoutEvent
					},300)
				},
				updateUi(){

					var p = this.provider;
					var u = this.user;
					var id = p ? p.providerId:null;
					if(!id && this.providerSelected) id = Provider.Id(this.providerSelected)
					var action = id

					this.$.verify.hide()
					switch(id){
						case 'password':
							action = 'login'
						case 'create':
							this.$.password.show();
							break;
						default:
							action = 'login'
							this.$.password.hide();
							break;
					}
					if(this.loggedIn){
						action='logout';
						this.$.email.hold(false,true);
						if(this.$.displayName.empty) this.$.displayName.hold(true,true);
						else this.$.displayName.hold(false,true);
						this.$.editLink.style.display='';
						this.$.password.clear().hide();
						this.$.verify.clear();

					}else{
						if(p && id !== 'password' && id !== 'create') this.$.email.hold(false,false).placeholder='Automatically loaded from '+id+' account';
						else if(p) this.$.email.hold(false,false).placeholder='';
						else this.$.email.hold(true,false);
						this.$.editLink.style.display='none';
						this.$.displayName.hold(true,false);
						if(this.Shopbar) this.shopbar.closePaycard()
					}

					if(action === 'create') {
						this.$.verify.show();
						this.$.displayName.hold(false,false).placeholder='Class or user name (optional)';
					}
					this.$.submit.current = action;
					this.menu.disabled=this.loggedIn;
					if(this.loggedIn && this.user.photoURL) this.avatars.selectURL(this.user.photoURL);
					if(this.isPopover) {
						this.timer(()=>{
							this.dispatchEvent(new CustomEvent('resize',{bubbles:true}))
						})
					}

					return this;
				},

				setProviders(){
					this.$.linked.innerHTML = '';
					if(this.loggedIn){
						this.user.providers.then((prov)=>{
							let ops = prov ? prov.map((id)=>{return Provider.getKey(id)}).map((key)=>{return this.menu.get(key)}): [];
							return ops.forEach((op)=>{
								let name = op.name;
								var cont = this.querySelector('[name="'+name+'"] .option-container');
								if(!cont) cont = this.root.querySelector('[name="'+name+'"] .option-container')
								if(!cont) cont = op.$$('.option-container');
								if(cont){
									let clone = cont.cloneNode(true);
									this.$.linked.appendChild(clone);
								}

							})
						}).catch((err)=>{
							console.error(err);
							this.$.linked.innerHTML = '';
						});
					}
					return this;
				},
				updateAuth(user){
					if(user && user.isAnonymous) return this;
					this.user.update(user);
					this.user.delete('license');
					if(this.loggedIn){
						var key = Provider.getKey(this.user.providerId);
						if(key) this.menu.get(key)._tap()
						if(this.user.email) this.shopbar.contactEmail = this.user.email
					}else{
						this.menu.clear();
						this.provider=null;
						this.shopbar.contactEmail = 'Contact Email'
					}
					if(this.menu.active) this.menu.toggle();
					this.setLicense(this.user).updateUi();
					this.setProviders();
					if(this.user.isContext){
						if(this.user.onLogin){
							this.user.onLogin.changed(this)
						}
					}
				},
				setLicense(user){
					let acct=this;
					this.$.license.user = null;
					if(user !== null && typeof this.KindleLicense === 'undefined') {
						let mainel = user.Context.element;
						if(typeof mainel.KindleLicense === 'undefined') mainel.KindleLicense = new KindleLicense()
						else this.KindleLicense = mainel.KindleLicense;
					}
					if(this.KindleLicense) this.KindleLicense.setUser(user.Context);
					if(user.emitters.has('active-license') !== true){
						user.on('active-license',function(e){
							this.user.Context.delete('license');
							let value = e.detail.toJSON()
							value.session=this.user.Context.session;
							this.KindleLicense.setValue(value);
						}.bind(this));

						user.on('license',function(e){
							var expired=true;
							var notify=false;
							var context = this.Context;
							if(context !== this) return;
							let detail = e && e.detail ? e.detail:null;
							let license = context.has('license') ? context.get('license'):null;
							if(license && detail && detail.session) {
								if(detail.session && detail.session.accessToken !== license.session.accessToken) expired = true;
								else expired = false;
								if(expired) notify=true;
							}else expired=false;

							if(expired) context.delete('license')
							else context.set('license',detail)
							if(notify) {
								context.element.Msg('You have been logged out because the account was accessed from a different device.', false, Infinity, (type) => {
									if (type === 'open') {
										window.setTimeout(() => {
											context.element.auth.signOut().then(()=>{
	//											window.location.search='auto-logged-out=true';
												context.delete('license')
												window.location.hash = 'login';
												context.element.msg.close()
											}).catch(()=>{
												context.delete('license')
	//											window.location.search='auto-logged-out=true';
												window.location.hash = 'login';
												context.element.msg.close()
											})
										}, 3000)
									}
								})
							}

						}.bind(user))
					}
					this.$.license.user=user;

					return this;
				},
				ready(){


					window.firebase.auth().onAuthStateChanged((user) => { this.updateAuth(user); });

					this.menu.addEventListener('selected',(e)=>{
						if(e.detail){
							this.providerSelected = e.detail.name;
							this.provider = Provider.Provider( this.providerSelected );
							this.updateUi();
						}
					});

					window.addEventListener('avatar',(e)=>{
						var detail = e.detail;
						if(this.loggedIn && detail && detail.userSelected) this.updateUserProfile();
					});



				},
				attached(){
					var avs = this.avatars
				}
			})


		},['firebase'])



	</script>
</dom-module>




