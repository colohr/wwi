<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="scripts.html">



<dom-module id="shop-bar">
	<template>
		<style include="www-selection-styles">

			:host {
				display: block;
				position:fixed;
				top:3px;
				left:3px;
				right:3px;
				height:0px;
				overflow:hidden;
				border-radius: 7px;
				z-index:-1;
				background:var(--blue);
				-webkit-filter:drop-shadow(0px 2px 8px rgba(100,140,150,0.64));
				filter:drop-shadow(0px 2px 8px rgba(100,140,150,0.64));
				will-change: transform, opacity, height;
				transition-property: transform, opacity, height;
				transition-timing-function: cubic-bezier(0.25, 0.1, 0, 1.03);
				transition-duration: 300ms;
				transform-style: preserve-3d;
				opacity:0;
				transform:translate3d(0,-50px,-100px);
				box-sizing: content-box;
				@apply --no-selection;
				outline: none;
			}
			pay-button{
				color:white;
			}

			:host([active]){
				height:64px;
				transform:translate3d(0,0,0);
				z-index: 80;
				opacity:1;
			}



			::content #view,
			#view{
				display:none;
				position:relative;
				padding:10px;
				width:calc(100% - 20px);
				overflow:hidden;
			}

			:host([active]) #view,
			:host([active]) ::content #view{
				display:block;
			}


			::content .button,
			.button{
				@apply(--layout-inline);
				@apply(--layout-center-center);
				@apply(--layout-self-center);
				font-size:24px;
				color:white;
				background:rgba(250,250,250,0.3);
				padding:5px;
				height:48px;
				width:48px;
				border-radius: 100px;
				border:1px solid rgba(250,250,250,0.5);
				box-sizing: border-box;
				margin-left:1px;
				margin-right:5px;
				outline:none;
			}

			::content .button::not([disabled]),
			.button::not([disabled]){
				pointer-events: auto;
				cursor: pointer;
			}

			::content .button[disabled],
			.button[disabled]{
				pointer-events: none;
				cursor: default;
			}

			::content .button.text,
			.button.text{
				width:auto;
				padding:5px 14px 5px 14px;
				font-size:16px;
				height:auto;
				pointer-events: auto;
				cursor: pointer;
				background:rgba(250,250,250,0.13);

			}


			::content .button.text:hover,
			:host([expanded]) ::content #details > .button.text,
			.button.text:hover,
			:host([expanded]) #details > .button.text{
				background:rgba(250,250,250,0.24);
				color:rgba(250,250,250,1);
				border:1px solid rgba(250,250,250,0.4);
			}

			::content .button.text:focus,
			::content .button.text:active,
			:host([expanded]) ::content #details > .button.text,
			.button.text:focus,
			.button.text:active,
			:host([expanded]) #details > .button.text{
				border:1px solid rgba(250,250,250,0.7);
				color:white;
			}

			::content #ticket,
			#ticket{
				@apply(--layout-flex);
				@apply(--layout-horizontal);
				@apply(--layout-center-center);
				color:white;
			}

			::content #ticket #title,
			#ticket #title{
				font-size:16px;
				@apply(--layout-inline);
				@apply(--layout-center);
				@apply(--layout-flex-1);
				text-align: left;
				margin-left:7px;
			}

			::content #ticket #details,
			#ticket #details{
				font-size:16px;
				@apply(--layout-inline);
				@apply(--layout-center);
				@apply(--layout-flex-4);
				text-align: left;
				margin-left:14px;
				margin-right:14px;
			}

			::content #ticket #total,
			#ticket #total{
				@apply(--layout);
				@apply(--layout-self-center);
				font-weight: bold;
				text-align: right;
				padding:3px 10px 3px 10px;
				background:rgba(250,250,250,0.3);
				border:1px solid rgba(250,250,250,0.5);
				box-sizing: border-box;
				margin-left:1px;
				margin-right:18px;
				border-radius:100px;
				height:26px;
				max-width:140px;
				overflow:hidden;
				white-space:nowrap;
				text-overflow: ellipsis;

				-webkit-touch-callout: none;
				-webkit-user-select: all;
				-moz-user-select: all;
				-ms-user-select: all;
				user-select: all;
			}

			::content #list,
			#list{
				position: relative;
				display: none;
				max-width: initial;
				will-change: max-height;
				transition-property: max-height;
				transition-timing-function: cubic-bezier(0.25, 0.1, 0, 1.03);
				transition-duration: 200ms;

			}

			:host([expanded]) ::content #list,
			:host([expanded]) #list{
				@apply(--layout);
				@apply(--layout-vertical);
				padding:0px 14px 14px 14px;
			}

			::content #list #items-title,
			#list #items-title{
				padding:0px 3px 3px 3px;
				border-bottom: 1px dotted rgba(250,250,250,0.25);
				color:rgba(250,250,250,0.98);
				font-size:14px;
				font-weight: 700;
			}

			::content #list #items,
			#list #items{
				@apply(--layout-wrap);
				@apply(--layout-start);
				@apply(--layout-flex-3);
				@apply(--layout-horizontal);
				position: relative;
				font-size:14px;
				padding-top: 12px;
				padding-bottom: 12px;
				padding-right: 12px;
				max-height:300px;
				overflow-y:auto;
				z-index: 1;
			}


			::content #items .order-item,
			#items .order-item{
				@apply(--layout);
				@apply(--layout-horizontal);
				@apply(--layout-center-center);
				pointer-events: auto;
				cursor: pointer;
				box-sizing: border-box;
				margin-left:3px;
				margin-right:3px;
				background-color:rgb(66, 133, 244);
				position: relative;
				border:1px solid rgba(250,250,250,0.5);
				border-bottom:0px;
				color:rgba(250,250,250,0.98);
				width:100%;

			}

			::content #items > .order-item:nth-child(even),
			#items > .order-item:nth-child(even){
				background-color: rgba(127, 184, 255, 0.3);
			}

			::content #items > .order-item:nth-child(odd),
			#items > .order-item:nth-child(odd){
				background-color: rgba(71, 132, 229, 0.35);
			}

			::content #items > .order-item:first-child,
			#items > .order-item:first-child{
				border-top-left-radius: 6px;
				border-top-right-radius: 6px;
				border-top:1px solid rgba(250,250,250,0.5);
			}

			::content #items > .order-item:last-child,
			#items > .order-item:last-child{
				border-bottom:1px solid rgba(250,250,250,0.5);
				border-bottom-left-radius: 6px;
				border-bottom-right-radius: 6px;
			}



			::content #items .item,
			#items .item{
				position: relative;
				@apply(--layout-flex-6);
				@apply(--layout-horizontal);

				height:27px;
			}

			#items .item > div,
			::content #items .item > div{
				@apply(--layout-inline);
				position: relative;
				padding-left:10px;
				padding-right:10px;
				height:100%;
				@apply(--layout-center);
			}

			#items  .detail,
			::content #items .detail{
				@apply(--layout-flex-3);
			}

			::content .item div:nth-child(odd),
			.item div:nth-child(odd){
				-webkit-filter:contrast(110%);
				filter:contrast(110%);
			}
			::content .item div:nth-child(even),
			.item div:nth-child(even){
				-webkit-filter:saturate(110%) contrast(120%);
				filter:saturate(110%) contrast(120%);
			}

			::content #items .detail,
			#items .detail{
				@apply(--layout-horizontal);
				@apply(--layout-around-aligned);
			}
			::content #items .inner
			#items .inner{
				text-transform: capitalize;
				@apply(--layout-flex);
			}


			#items .item > .name,
			::content .item > .name{
				font-weight: 700;
			}

			.item > b,
			::content  .item > b,
			.item > .duration,
			::content .item > .duration,
			#items .item > .name,
			::content .item > .name,
			.item .type,
			::content .item .type{
				@apply(--layout-inline);
				@apply(--layout-flex-1);
				white-space: nowrap;
				text-overflow: ellipsis;
			}

			#items .item > .name,
			::content .item > .name{
				@apply(--layout-flex-2);
			}

			.item > .duration,
			::content .item > .duration{
				font-style: italic;
				width:140px;
			}


			::content .item > i,
			.item > i,
			::content .item > .price,
			.item > .price{
				@apply(--layout-flex);
				@apply(--layout-end);
				text-align: right;
			}


			::content .order-item close-button,
			.order-item close-button{display:none;}

			:host([active][expanded]) ::content .order-item close-button,
			:host([active][expanded]) .order-item close-button{
				@apply(--layout-inline);
				@apply(--layout-flex-1);
				margin-left:5px;
				margin-right:10px;
			}

			::content #view close-button,
			#view close-button{
				margin-right: 2px;
				margin-top: 1px;
			}

			::content pay-button,
			pay-button{
				margin-right:35px;
				margin-left:5px;
			}
			.button.text.email-button{
				display:inline-block;
				white-space: nowrap;
				text-overflow: ellipsis;
				max-width: 24%;
				overflow: hidden;
				text-align: left;
			}


		</style>
		<div id="view" >
			<div id="ticket">
				<div id="title">[[currentTitle]]</div>
				<div id="details">
					<a aria-label="Toggle Order Details" tabindex="0" on-tap="details" class="button text">
						Details
					</a>
					<a id="account-button" aria-label="User contact email address" on-tap="showShopper" class="button text email-button">
						[[contactEmail]]
					</a>
					<a aria-label="See the refund policy" on-tap="gotoRefundPolicy" class="button text">
						Refund Policy
					</a>
					<a  aria-label="Contact us" on-tap="gotoCompanyContact" class="button text">
						Contact Us
					</a>
				</div>
				<div id="total" class="yellow-select">[[totalValue]]</div>
				<back-button label="Go back." class="button"></back-button>
				<pay-button label="Finish order payment." id="finishButton"></pay-button>
			</div>

			<close-button label="Cancel order." dim color="white" size="21" corner="top right"></close-button>
		</div>
		<div id="list">
			<div id="items-title">Items</div>
			<div id="items"></div>
		</div>


	</template>
	<script>
		(function(){
			Polymer({
				is: "shop-bar",
				hostAttributes:{
					'role':'combobox',
					'aria-label':'Shopping Cart',
					'tabindex':'-1'
				},
				properties: {
					active:{
						type:Boolean,
						reflectToAttribute:true,
						value:false
					},
					expanded:{
						type:Boolean,
						reflectToAttribute:true,
						value:false
					},
					shopper:{type:Object,observer:'onShopper'},
					step:{type:Number,value:-1},
					steps:Array,
					current:Object,
					totalValue:String,
					currentTitle:{type:String,value:'Shop Cart'},
					contactEmail:{type:String,value:'User Email'},
					logoHTML:{type:String,observer:'onLogo'},
					companyContact:{type:String,value:'#features/contact'},
					companyRefundPolicy:{type:String,value:'#features/refund'}

				},
				observers: [
					'onStep(step)'
				],
				listeners:{
					'tap':'expand'
				},
				get limit(){return this.steps ? this.steps.length:0;},
				get total(){ return this.shopper ? this.shopper.bundle.total:null; },
				gotoRefundPolicy(e){
					if(e.stopPropagation) e.stopPropagation()
					if(e.preventDefault) e.preventDefault()
					window.location.hash = this.companyRefundPolicy;
					window.dispatchEvent(new CustomEvent('refund-policy',{bubbles:true}))
				},
				gotoCompanyContact(e){
					if(e.stopPropagation) e.stopPropagation()
					if(e.preventDefault) e.preventDefault()
					window.location.hash = this.companyContact;
					window.dispatchEvent(new CustomEvent('company-contact',{bubbles:true}))
				},
				onLogo(html){
					if(html){
						this.$.title.innerHTML = html;
						this.titleIsLogo=true;
					}else{
						this.titleIsLogo=false;
					}
				},
				getCountOrTotal(data,count){
					//				console.log({data})
					if(!data) return '';
					var total = this.total;
					if(typeof count === 'undefined' && !total) count=true;
					if(count && Array.isArray(data)) {
						var count = 0;
						for(var i = 0;i<data.length;i++){
							var item = data[i]
							var len = item.quantity ? item.quantity:1;
							count += len;
						}
						return count > 1 ? count + ' Items':count +' Item';
					}
					return '$'+total.toFixed(2);
				},
				onStep(current,last){

					if(!this.steps) return;

					let back = this.$$('back-button');
					let next = this.$$('next-button');
					if(current === -1){
						if(back.hide) back.hide();
					}
					if(current >= 0){
						if(current > 0) this.$$('back-button').show();
						else this.$$('back-button').hide();

						this.$.items.innerHTML = '';
						var currentStep=this.steps[current];
						if(currentStep.title || !this.titleIsLogo){
							this.currentTitle = currentStep.title
						}
						this.current=currentStep
						if(current === 1){ this.show(); }
						if(this.current.type === 'items') ShopBar.Item.Items(this.current.data,this.$.items,this);
						if(this.current.type === 'finish') this.expanded=false;
						this.totalValue = this.getCountOrTotal(this.current.data)
					}
					this.expand(true);
					if(!this.current){
						this.hide();
					}

					if(!this.finished){
						if(this.paycard) this.paycard.active=false;
					}
				},
				onShopper(shopper){
					if(shopper && shopper.email){
						this.contactEmail = shopper.email;
					}else{
						this.contactEmail = 'User Email'
					}
				},
				update(shopper){
					if(shopper) this.shopper=shopper;
					shopper = this.shopper;
					var shopbar = this;

					shopbar.step=-1;
					shopbar.steps = [
						{title:'Kindle Publishing',data:shopper.bundle.items,type:'items'},
						{title:'Finish Order',data:shopper.bundle,type:'finish'}
					]
					if(shopper.bundle.items.length <= 0){
						this.expanded=false;
					}
					shopbar.show();
					if(shopbar.paycard) shopbar.paycard.shopper=this.shopper;
					return shopbar;
				},
				removeItem(e){
					if(this.expanded){
						var target = e.currentTarget;
						this.shopper.bundle.remove(target.dataset.index);
						this.update();
						if(this.shopper.bundle.items.length <= 0){
							this.hide();
						}
					}
				},
				back(e){
					if(e) e.stopPropagation()
					if(this.step > 0){
						this.step = this.step-1;
					}else{
						this.step=0;
					}
				},
				next(e){
					if(e) e.stopPropagation()
					if(this.step === this.limit-1){}
					else{
						this.step = this.step+1;
					}
					if(this.step === this.limit-1){
						this.finish();
					}
				},

				get finished(){
					return this.step === this.limit-1;
				},
				finish(){

					this.hide();
				},
				showShopper(e){
					e.stopPropagation();
					return this.onMessage(new CustomEvent('account',{bubbles:true,detail:{
						action:'account',
						account:{
							target:this.$$('#account-button')
						}
					}}))
				},
				pay(e){
					if(!this.active) return;
					let shopper = this.shopper || {}
					var paycard = this.Paycard(this.active)
					if(!shopper || !shopper.email){
						if(paycard) paycard.active=false;

						let action = !shopper.loggedIn ? 'login':'email'
						let detail = {
							action:action
						}
						let ensure = {
							shopbar:this,
							target:this.$$('pay-button'),
							bundle:this.shopper.bundle
						}
						if(action === 'login'){
							ensure.changed = function(account){
								if(account.user.email) {
									this.shopbar.contactEmail = user.email;
								}
								this.shopbar.pay();
							}
						}else{
							ensure.changed = function(account){
								if(account.user.email) {
									this.shopbar.contactEmail = user.email;
								}
								this.shopbar.pay();

							}
						}
						detail[action] = ensure;
						return this.onMessage(new CustomEvent(action,{bubbles:true,detail}))
					}

					if(paycard){
						if(paycard.active) paycard.active=false;
						else paycard.active=true;
					}
				},
				show(){
					if(this.finished){
						this.step = this.limit-1;
					}else if(this.step === -1){
						this.step=0;
					}
					this.setAttribute('aria-disabled','false');
					this.setAttribute('aria-expanded','true');
					this.style.pointerEvents = 'auto';
					this.active=true;
					this.Paycard(this.active);
					this.focus();
				},
				hide(){
					this.active=false;
					this.expanded=false;
					this.setAttribute('aria-disabled','true');
					this.setAttribute('aria-expanded','false');
					this.style.pointerEvents = 'none';
					this.blur();
					return this.closePaycard()
				},
				closePaycard(){
					var paycard = this.Paycard(this.active)
					if(paycard) paycard.active=false;
					return this;
				},
				toggle(){
					if(!this.active) this.show();
					else this.hide();
				},

				shopbarEvent(e){
					var detail = e.detail;
					var action = detail.action;
					switch(action){
						case 'open':
						case 'start':
							this.step=1;
							break;
						case 'bundle':
							break;
						case 'steps':
							this.steps = detail.steps;
							break;
					}
				},
				expand(resize){
					if(typeof resize !== 'boolean'){
						if(this.current && this.current.type === 'finish') this.expanded=false;
						else this.expanded = this.expanded ? false:true;
					}
					if(this.expanded){
						var size = this.$.list.getBoundingClientRect();
						var height = 64;
						this.style.height=(height+size.height)+'px'
					}else{
						this.style.height='64px';
					}
				},
				onReceipt(e){

					var detail = e.detail
					this.receipt=detail;
					this.hide();
					var pc = this.Paycard(this.active);
					if(pc) pc.finished()
					return this.fire('message',{
						type:'receipt',
						detail:{
							message:'Purchase completed.  Thanks for using Kindle Sparks.',
							button:'Review',
							receipt:this.receipt
						}
					});

				},
				onError(e){ return this.fire('message',e); },
				onMessage(e){ return this.fire('message',e); },
				Paycard(active){
					if(active && !this.paycard){
						var paycard = window.document.body.querySelector('pay-card')
						if(!paycard){
							paycard = document.createElement('pay-card')
							window.document.body.appendChild(paycard);
						}
						this.paycard = paycard;
						this.paycard.addEventListener('receipt',this.onReceipt.bind(this))
						this.paycard.addEventListener('error',this.onError.bind(this))
						this.paycard.addEventListener('message',this.onMessage.bind(this))
					}
					return this.paycard;
				},
				ready(){
					this.paycard = null
					window.addEventListener('shopbar',this.shopbarEvent.bind(this));
					customElements.whenDefined('next-button').then(()=>{
						this.$$('close-button').on('close',this.hide.bind(this));
						this.$$('back-button').on('back',this.back.bind(this));
						this.$$('pay-button').on('pay',this.pay.bind(this));
					});
				}

			});
		})();

	</script>
</dom-module>