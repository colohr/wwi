<!--<link rel="import" href="provider.html">-->
<link rel="import" href="../../style/doms/gui-attr.html">
<link rel="import" href="avatar/picker.html">
<link rel="import" href="avatar/item.html">

<script>
	/*
	@polymerBehavior UserProfileBehavior
	* */
	var UserProfileBeheavior = {
		properties:{
			email:{type:String},
			licensed:{
				type:Boolean,
				reflectToAttribute:true,
				value:false
			},
			loggedIn:{
				type:Boolean,
				reflectToAttribute:true,
				value:false
			}
		},
		getUser(){
			var user = null;
			if('user' in window) user = window.user;
			if(!user && 'firebase' in window){
				var auth = firebase.auth();
				if(auth && auth.currentUser) user = auth.currentUser;
			}
			return user;
		},
		getUserData(){
			var user = this.getUser();
			var profile = user ? user.profile:null;
			var email = user ? user.email:null;
			var uid = user ? user.uid:null;
			var loggedIn = false;
			if(user){
				if(typeof user.uid === 'string') loggedIn = true;
			}
			var licensed = user ? user.isLicensed:false;
			var anon = user ? user.isAnonymous:false;
			return {
				profile,
				email,
				uid,
				loggedIn,
				licensed,
				anon
			};
		},
		updateUI(){
			var data = this.getUserData()
			this.email = data.email;
			this.licensed = data.licensed;
			this.loggedIn = data.loggedIn;
			console.log({updateUI:data})
		},
		authStateDidChange(e){
			this.updateUI();
		},
		attached(){
			if(window.firebase){
				if(firebase.auth){
					firebase.auth().onAuthStateChanged(this.authStateDidChange.bind(this));
				}
			}
			this.updateUI();
		}
	}
</script>

<dom-module id="user-badge">
	<template>
		<style include="gui-attr">
			:host {
				--gray-color: rgba(153, 160, 166, 1);
				--gray-fade:rgba(153, 160, 166, 0.26);
				--gray-text:#99a0a6;
				display: none;
				position:relative;
				width:130px;
				max-width: 130px;
				height:30px;
				max-height: 30px;
				cursor: default;
				pointer-events: none;
				border-radius: 100px;
				/*box-shadow: 0 0 0 1px var(--gray-fade);*/
				background-color: rgb(239, 240, 242);
				background-color: rgb(249, 250, 252);
				border:1px solid var(--gray-fade);
			}

			:host([logged-in]){
				display:block;
			}

			:host([positioned]){
				position: fixed;
				z-index: 100;
			}
			:host([top]){
				top:5px;
			}
			:host([bottom]){
				bottom:5px;
			}
			:host([left]){
				left:5px;
			}
			:host([right]){
				right:5px;
			}


			#container{
				position: relative;
				height:calc(100% - 4px);
				width:calc(100% - 8px);
				margin:2px 4px 2px 4px;
			}

			#container > div{
				position: relative;
				box-sizing: border-box;

			}

			.badge-email {
				max-width: calc(100% - 30px);
				width:calc(100% - 30px);
				white-space: nowrap;
				overflow: hidden;
				text-overflow: ellipsis;
				font-size:14px;
				font-weight: 300;
				text-align: left;
				color:var(--blue,dodgerblue);
			}

			.badge-icon{
				position: relative;
				background-image: url(/images/icon-sets/iconic/svg/sunny.svg);
				background-repeat:no-repeat;
				background-size:auto 90%;
				background-position: center center;
				margin:1px 1px 1px 0px;
				width:26px;
				height: 26px;
				left:-2px;
			}
			:host([licensed]) .badge-icon{
				background-image: url(/images/icon-sets/iconic/svg/luxury.svg);
			}

		</style>
		<div id="container" gui horizontal center-center no-select>
			<div class="badge-icon"></div>
			<div class="badge-email">[[email]]</div>
		</div>
	</template>
	<script>

		Polymer({
			is: "user-badge",
			behaviors:[UserProfileBeheavior],
			hostAttributes: {
				tabindex:'-1',
				'aria-label':'User email badge'
			},
			properties: {
				positioned:{
					value:Boolean,
					reflectToAttribute:true,
					value:false
				}
			}
		})

	</script>
</dom-module>
<!--<script>-->
	<!--'use strict';-->
	<!--class UserSchema extends Map{-->
		<!--static get classes(){-->
			<!--if(!this.Classes) this.Classes = new Map()-->
			<!--return this.Classes;-->
		<!--}-->
		<!--static get apiName(){return typeof ApplicationConfig === 'object' && ApplicationConfig.apiName ? ApplicationConfig.apiName : 'api'}-->
		<!--static get apiHeaders(){return typeof ApplicationConfig === 'object' && ApplicationConfig.apiHeaders ? ApplicationConfig.apiHeaders: {} }-->
		<!--static get tokenUrl(){return typeof ApplicationConfig === 'object'  && ApplicationConfig.tokenUrl ? ApplicationConfig.tokenUrl: '/user/login'}-->
		<!--static get postHeaders(){ return new Headers(Object.assign({'Content-Type':'application/json'},this.apiHeaders)) }-->
		<!--static get accessUrl(){return '/access/token'}-->
		<!--static reference(key){-->
			<!--return `${this.apiName}.user.${key}`-->
		<!--}-->
		<!--static errors(key,detail,message){-->

			<!--return (err)=>{-->
				<!--console.group(`UserSchema.${key || '?'}`)-->
				<!--if(message) console.info(message)-->
				<!--if(detail) console.dir(detail)-->
				<!--console.error(err)-->
				<!--console.groupEnd()-->
			<!--}-->
		<!--}-->
		<!--static post(url,data,returnFunc){-->
			<!--if(typeof returnFunc !== 'string') returnFunc = 'json'-->
			<!--return fetch(url,{-->
				<!--method:'POST',-->
				<!--body:JSON.stringify(data),-->
				<!--headers:this.postHeaders-->
			<!--}).then(res => res[returnFunc]()).catch(this.errors('post',{url,data,returnFunc}));-->
		<!--}-->
		<!--static fetch(url,returnFunc){-->
			<!--if(typeof returnFunc !== 'string') returnFunc = 'json'-->
			<!--return fetch(url).then(res => res[returnFunc]()).catch(this.errors('get',{url,returnFunc}));-->
		<!--}-->
		<!--static token(){-->
			<!--return this.fetch(this.tokenUrl,'text');-->
		<!--}-->
		<!--static getAccess(uid){-->
			<!--return this.post(this.accessUrl,{uid});-->
		<!--}-->
		<!--constructor(controller){-->
			<!--super()-->
			<!--if(!UserSchema.controller) UserSchema.controller = controller;-->
			<!--this.library=null;-->
			<!--this.banks=null;-->
			<!--this.location=null;-->
			<!--this.likes=null;-->
			<!--if(!UserSchema.keys) UserSchema.keys=Object.keys(this);-->
		<!--}-->
		<!--get controller(){return this.constructor.controller}-->
		<!--get classes(){return this.constructor.classes}-->
		<!--get data(){return this.controller ? this.controller.data:null}-->
		<!--get uid(){return this.controller ? this.controller.uid:null}-->
		<!--get session(){return this.controller ? this.controller.session:{sessionToken:null,needsLogin:true}}-->
		<!--event(key,data){ return new CustomEvent(this.constructor.reference(key),{bubbles:true,detail:data}); }-->
		<!--dispatch(key,data){ window.dispatchEvent(this.event(key,data)); return this;  }-->
		<!--valueChange(snapshot){-->
			<!--let key = snapshot.ref.parent.key;-->
			<!--if(this.has(key)){-->
				<!--this[key]=snapshot.val();-->
			<!--}-->
			<!--return this.dispatch(key,this[key]);-->
		<!--}-->
		<!--get tokens(){-->
			<!--return {-->
				<!--fire:this.session.refreshToken,-->
				<!--uid:this.uid,-->
				<!--ink:this.get('ink'),-->
				<!--print:this.get('print')-->
			<!--};-->
		<!--}-->
		<!--log(){-->
			<!--if(!this.uid) return UserSchema.needsLoginPromise()-->
			<!--return window.UserSchema.post(-->
			  <!--this.constructor.tokenUrl+'/'+UserSchema.controller.uid,-->
			  <!--{-->
				  <!--id:UserSchema.controller.uid,-->
				  <!--date:new Date(),-->
				  <!--profile:this.profile-->
			  <!--});-->
		<!--}-->
		<!--get values(){-->
			<!--return UserSchema.keys.filter((key)=>{-->
				<!--return this.has(key)-->
			<!--})-->
		<!--}-->
		<!--validate(o){-->
			<!--o.user = this.data;-->
			<!--return this;-->
		<!--}-->
		<!--connectClass(key){-->
			<!--if(!this.data) return this;-->
			<!--if(this.classes.has(key)){-->
				<!--if(!this.has(key)){-->
					<!--let Class = this.classes.get(key)-->
					<!--this.set(key,new Class())-->
				<!--}-->
			<!--}-->
			<!--if(this.has(key)){-->
				<!--let prop = this.get(key)-->
				<!--if(!prop.connected && prop.valid){-->
					<!--prop.ref.on('value',this.valueChange.bind(this))-->
					<!--prop.connected=true;-->
				<!--}-->
			<!--}-->
			<!--return this.get(key);-->
		<!--}-->
		<!--disconnectClass(key){-->
			<!--if(this.has(key)){-->
				<!--let prop = this.get(key)-->
				<!--if(prop.connected){-->
					<!--prop.ref.off('value',this.valueChange.bind(this));-->
					<!--delete prop.connected;-->
				<!--}-->
				<!--this.delete(key);-->
				<!--this[key] = null;-->
			<!--}-->
			<!--return this;-->
		<!--}-->
		<!--connectValues(){-->
			<!--if(!this.data) return this.values;-->
			<!--let keys = UserSchema.keys-->
			<!--keys.forEach((key)=>{-->
				<!--let prop = this.connectClass(key);-->
				<!--if(prop){-->
					<!--if(!prop.valid) prop.user = this.data;-->
				<!--}-->
			<!--});-->
			<!--return this.values;-->
		<!--}-->
		<!--disconnectValues(){-->
			<!--let keys = UserSchema.keys-->
			<!--keys.forEach(this.disconnectClass.bind(this));-->
			<!--return false;-->
		<!--}-->
		<!--connect(data){-->

			<!--if(data === null) {-->
				<!--this.connected = this.disconnectValues();-->
			<!--}-->
			<!--else{-->
				<!--this.connected = this.connectValues();-->

			<!--}-->
			<!--window.dispatchEvent(new CustomEvent('user.changed',{bubbles:true,detail:this}));-->
			<!--return this;-->
		<!--}-->
	<!--}-->
<!--</script>-->

<!--<script>-->
	<!--'use strict';-->
	<!--class UserBase extends ValueMixin(Provider){-->
		<!--get name(){return this.displayName; }-->
		<!--get displayName(){ return this.profile.displayName; }-->
		<!--set displayName(v){ return this.input('displayName',v); }-->
		<!--get email(){ return this.profile.email || null; }-->
		<!--set email(v){ return this.input('email',v) }-->
		<!--get emailVerified(){ return this.profile.emailVerified; }-->
		<!--get isAnonymous(){ return this.profile.isAnonymous; }-->
		<!--get loggedIn(){return typeof this.data.uid === 'string'}-->
		<!--get sessionId(){return this.Context.get('session-id')}-->
		<!--constructor(element,data){-->
			<!--super(data)-->
			<!--this.element=element;-->
			<!--this.set('session-id',Date.now())-->
		<!--}-->
		<!--Delete(){return this.data && this.data.delete ? this.data.delete():new Promise((resolve)=>{return resolve({needsLogin:true})})}-->
		<!--Reload(){return this.data && this.data.reload ? this.data.reload():new Promise((resolve)=>{return resolve({needsLogin:true})})}-->
		<!--SendVerification(){ return this.data && this.data.sendEmailVerification ? this.data.sendEmailVerification():new Promise((resolve)=>{return resolve({needsLogin:true})}) }-->
		<!--ReAuthorize(credential){ return this.data && this.data.reauthenticate ? this.data.reauthenticate(credential):new Promise((resolve)=>{return resolve({needsLogin:true})}) }-->
		<!--Link(credential){ return this.data && this.data.link ? this.data.link(credential):new Promise((resolve)=>{return resolve({needsLogin:true})}) }-->
		<!--Unlink(providerId){ return this.data && this.data.unlink ? this.data.unlink(providerId):new Promise((resolve)=>{return resolve({needsLogin:true})}) }-->

		<!--getProfileChanges(state,changes){-->
			<!--var changed = {};-->
			<!--for(var key in state){-->
				<!--if(typeof changes[key] === 'string'){-->
					<!--if(changes[key] !== state[key]){-->
						<!--changed[key] = changes[key]-->
					<!--}-->
				<!--}-->
			<!--}-->
			<!--return changed;-->
		<!--}-->
		<!--updateEmail(email){-->
			<!--if(this.data && this.data.updateEmail){-->
				<!--return this.data.updateEmail(email)-->
			<!--}-->
			<!--return new Promise((resolve)=>{return resolve()})-->
		<!--}-->
		<!--updateProfile(profile){-->
			<!--if(this.data && this.data.updateProfile) return this.data.updateProfile(profile);-->
			<!--return new Promise((resolve)=>{return resolve()})-->
		<!--}-->
		<!--get session(){-->
			<!--let data = this.data && this.data.toJSON ? this.data.toJSON():{};-->
			<!--if(data.stsTokenManager) {-->
				<!--let out = data.stsTokenManager;-->
				<!--out.sessionId = this.sessionId;-->
				<!--return out;-->
			<!--}-->
			<!--return {token:false,date:new Date(),expires:Date.now()};-->
		<!--}-->
		<!--json(){-->
			<!--if(!this.loggedIn) return {needsLogin:true}-->
			<!--var profile=this.profile;-->
			<!--profile.uid=this.uid;-->
			<!--return profile;-->
		<!--}-->
	<!--}-->
<!--</script>-->

<!--<script>-->
	<!--'use strict';-->
	<!--class UserDependent extends Map{-->
		<!--static nullPromise(){return new Promise((resolve)=>{return resolve(null)})}-->
		<!--static needsLoginPromise(){return new Promise((resolve)=>{return resolve({needsLogin:true})})}-->
		<!--static rejectPromise(msg){return new Promise((resolve,reject)=>{return reject(new Error(msg || 'user rejection'))})}-->
		<!--static valuePromise(val){return new Promise((val)=>{return resolve(val)})}-->
		<!--constructor(key){-->
			<!--super([['listeners',new Set()]])-->
			<!--if(key) this.set('dependent',key)-->
			<!--if(this.key){-->
				<!--window.addEventListener(UserSchema.apiName+'.user.'+this.key,this.changedValue.bind(this))-->
			<!--}-->
		<!--}-->
		<!--get listeners(){return this.get('listeners')}-->
		<!--get key(){return this.get('dependent')}-->
		<!--get value(){return this.get('dependentValue')}-->
		<!--set value(value){-->
			<!--let last = this.get('dependentValue')-->
			<!--if(value === null) this.delete('dependentValue')-->
			<!--else this.set('dependentValue',value)-->
			<!--if(last !== value) this.notify('value',value,last)-->
		<!--}-->
		<!--get user(){return this.get('user')}-->
		<!--set user(v){-->
			<!--if(v === null) this.delete('user')-->
			<!--else this.set('user',v)-->
			<!--if(this.update) this.update();-->
		<!--}-->
		<!--get valid(){return this.key && this.user && this.user.uid}-->
		<!--get uid(){return this.valid ? this.user.uid:null}-->
		<!--get path(){ return this.valid ? `/user/${this.key}/${this.uid}`:null}-->
		<!--get ref(){-->
			<!--if(!this.valid) return null;-->
			<!--return window.firebase.database().ref(this.path)-->
		<!--}-->
		<!--child(key){-->
			<!--let ref = this.ref;-->
			<!--if(ref && typeof key === 'string') return ref.child(key);-->
			<!--return UserDependent.needsLoginPromise();-->
		<!--}-->
		<!--changedValue(e){-->
			<!--this.value = e && e.detail ? e.detail:null-->
			<!--if(window.user.emitters.has(this.key)) window.user.emit(this.key,this)-->
			<!--return this;-->
		<!--}-->
		<!--update(){-->
			<!--let key = this.key-->
			<!--if(this.key){-->
				<!--if(this.user) return UserSchema.controller.schema.connectClass(key)-->
				<!--else return UserSchema.controller.schema.disconnectClass(key)-->
			<!--}-->
			<!--throw new Error('no dependent key value for user dependency',this)-->
		<!--}-->
		<!--attach(listener){-->
			<!--this.listeners.add(listener);-->
			<!--if(typeof listener === 'function') listener(this.value,null,this.key)-->
			<!--else if(listener instanceof HTMLElement){-->
				<!--listener.dispatchEvent(new CustomEvent(this.key+'.changed',{bubbles:true,detail:{name:this.key,value:this.value,last:null}}))-->
			<!--}-->
			<!--return this;-->
		<!--}-->
		<!--detach(listener){-->
			<!--this.listeners.delete(listener)-->
			<!--return this;-->
		<!--}-->
		<!--notify(name,value,last){-->
			<!--for(let er in this.listeners){-->
				<!--if(typeof er === 'function') er(value,last,name)-->
				<!--else if(er instanceof HTMLElement){-->
					<!--er.dispatchEvent(new CustomEvent(this.key+'.changed',{bubbles:true,detail:{name,value,last}}))-->
				<!--}-->
			<!--}-->
			<!--return this;-->
		<!--}-->
	<!--}-->
<!--</script>-->



<!--<script>-->
	<!--'use strict';-->
	<!--UserSchema.classes.set('library',class UserLibrary extends UserDependent{-->
		<!--static get element(){ return this.Element; }-->
		<!--constructor(){ super('library') }-->
		<!--get elementClass(){return this.constructor.element}-->
		<!--addBank(data){-->
			<!--var ref = {-->
				<!--key:data.key,-->
				<!--title:data.title,-->
				<!--grade:'grade' in data ? data.grade:data.grade.position,-->
				<!--core:data.core-->
			<!--};-->
			<!--let child = this.child(ref.title)-->
			<!--if(child.set){-->
				<!--return child.set(ref).then((updated)=>{-->
					<!--return {updated:true,added:true,action:'addBank'};-->
				<!--});-->
			<!--}-->
			<!--return child;-->
		<!--}-->
		<!--removeBank(title){-->
			<!--let child = this.child(title)-->
			<!--if(child.set){-->
				<!--return child.set(null).then((updated)=>{-->
					<!--return {updated:true,removed:true,action:'removeBank'};-->
				<!--});-->
			<!--}-->
			<!--return child;-->
		<!--}-->
		<!--hasBank(title){-->
			<!--let v = this.value-->
			<!--if(v && title in v) return true-->
			<!--return false-->
		<!--}-->

	<!--});-->
<!--//	window.addEventListener('user.schema.library',function(e){-->
<!--//		UserSchema.classes.get('library').Element = e.detail.Element;-->
<!--//		if(UserSchema.controller){-->
<!--//			UserSchema.controller.schema.connect(UserSchema.controller.data)-->
<!--//		}-->
<!--//	},false)-->


<!--</script>-->

<!--<script>-->
	<!--'use strict';-->
	<!--class KindlePublishingUser extends UserBase{-->


		<!--constructor(element,data){-->
			<!--super(element,data)-->
			<!--this.schema = new UserSchema(this)-->

		<!--}-->
		<!--get token(){return KindlePublishingUser.token}-->
		<!--set token(v){-->
			<!--if(v === null) delete KindlePublishingUser.token;-->
			<!--else KindlePublishingUser.token = v;-->
		<!--}-->
		<!--get popover(){-->
			<!--let popover = window.app.query('user.popover');-->
			<!--if(popover && !popover.account){-->
				<!--var account = null-->
				<!--if(popover.queryEffectiveChildren) account = popover.queryEffectiveChildren('[is-user-account]')-->
				<!--if(!account) account = popover.querySelector('[is-user-account]')-->
				<!--if(account) account.isPopover=true-->
				<!--if(!account && popover.root) {-->
					<!--account = popover.root.querySelector('[is-user-account]')-->
				<!--}-->
				<!--popover.account=account-->


				<!--if(!popover.resizeListener){-->
					<!--popover.resizeListener = function(e){-->
						<!--let detail = e.detail || null-->
						<!--let rect = app.duplicate(e.currentTarget.getBoundingClientRect())-->
						<!--let pop = popover.getBoundingClientRect()-->
						<!--let height = this.$.inner.scrollHeight-->
						<!--let width = this.$.inner.scrollWidth-->
						<!--let size = detail || {}-->
<!--//						if(!size.height && pop.height < (rect.height+5)) size.height = (pop.height+5)+'px'-->
<!--//						if(!size.width && pop.width < rect.width+10) size.width = (pop.width+10)+'px'-->
						<!--Object.assign(this.style,size)-->
<!--//						console.log({size})-->
					<!--}-->

					<!--popover.account.addEventListener('resize',(e)=>{-->

						<!--popover.resizeListener(e);-->
					<!--})-->
				<!--}-->
			<!--}-->
			<!--return popover-->
		<!--}-->
		<!--get access(){ return this.constructor.access || {} }-->
		<!--get shopper(){-->
			<!--if(!this.Shopper){ this.Shopper = new KPShopper(this) }-->
			<!--if(!this.Shopper.userId !== this.uid) this.Shopper.updateUser(this);-->
			<!--return this.Shopper;-->
		<!--}-->
		<!--get library(){ return this.schema.get('library') }-->
		<!--get license(){return this.element.KindleLicense}-->
		<!--get isLicensed(){-->
			<!--if(this.license && this.license.dataValue){-->
				<!--return this.license.dataValue.expired === false-->
			<!--}-->
			<!--return false-->
		<!--}-->
		<!--clearData(){-->
			<!--this.email = '';-->
			<!--this.displayName='';-->
			<!--this.data = null;-->
			<!--return this;-->
		<!--}-->
		<!--updateData(){-->
			<!--if(!this.loggedIn) return this.clearData();-->
			<!--var profile=this.profile;-->
			<!--this.email=profile.email;-->
			<!--this.displayName=profile.displayName;-->
			<!--return this;-->
		<!--}-->
		<!--destroy(key){-->
			<!--switch(key){-->
				<!--case 'shopper':-->
					<!--this.Shopper=new KPShopper(this)-->
					<!--break;-->
			<!--}-->
			<!--return this;-->
		<!--}-->
		<!--update(data){-->
			<!--delete this.constructor.access-->
			<!--this.token=null;-->
			<!--this.data=data;-->
			<!--if(this.loggedIn){-->
				<!--if(this.isContext && this.email){-->
					<!--let lastLogged = {-->
						<!--user:{-->
							<!--email:this.email,-->
							<!--timestamp:firebase.database.ServerValue.TIMESTAMP,-->
							<!--uid:this.uid-->
						<!--},-->
						<!--ref:window.firebase.database().ref('/teachers/'+this.uid)-->
					<!--}-->
					<!--lastLogged.ref.update(lastLogged.user).then(()=>{-->
<!--//						console.log('has teacher')-->
						<!--KindlePublishingUser.lastLogged=lastLogged;-->
					<!--});-->
					<!--lastLogged.ref.onDisconnect().remove((errs)=>{-->
						<!--if(errs) console.error(errs)-->
					<!--})-->
				<!--}-->
				<!--UserSchema.token().then((token)=>{-->
					<!--this.token = token;-->
					<!--if(this.token){-->
						<!--UserSchema.getAccess(this.uid).then((access)=>{-->
							<!--if(access.success) this.constructor.access = access;-->
							<!--else delete this.constructor.access-->
							<!--this.Context.emit('login',this);-->
						<!--})-->
					<!--}-->
				<!--})-->
			<!--}else {-->
				<!--this.Context.emit('logout',this);-->
				<!--if(this.emitters.has('library')) this.emit('library',{value:null})-->
			<!--}-->
			<!--this.schema.connect(data);-->
			<!--return this;-->
		<!--}-->


	<!--}-->
<!--</script>-->