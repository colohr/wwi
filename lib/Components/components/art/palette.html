<template id="art-palette">
    <style>
        @import "/modules/wwi/component/design/host.css";
        :host{
	        position:relative;
	        max-height:100%;
	        height:100%;

        }
        [view]{
	        background:var(--dark);
	        max-height:100%;
	        overflow-y:auto;
	        width: calc(50vw - 100px);
        }
        content-menu{
	        display: inline-block;
	        width:100%;

        }

	    content-button{
		    margin:5px;
		    position:relative;
	    }
	    [value]{
		    display:block;
		    position:relative;
		    background-color: white;
	    }
    </style>
	<div view>
		<content-menu grid multi no-header id="colors"></content-menu>
	</div>
</template>
<script>
    (function(doc){
        const ArtPalette = wwi.element(doc).extension({name:'Palette',module:'behavior'})
        ArtPalette(class extends ArtPalette.Element{
        	constructor(){
        		super('routes',{
        			url(value){
        				if(value !== null) this.palette = value
			        },
			        gradient_size(value){
        				if(value !== null){
        					this.preview.height=value
					        this.preview.width=value
					        this.box.style.height =value+'px'
					        this.view.style.width = `calc(50vw - (10px + ${value}px))`
				        }
			        }
		        })
	        }
	        connected(){
		        let timeout_id = null
	        	this.box = document.createElement('wwe-position')
		        this.box.setAttribute('no-title','')
		        this.preview = document.createElement('canvas')
		        this.preview.setAttribute('preview','')
		        this.preview.style.boxSizing='border-box'
		        this.preview.style.position='relative'
		        this.box.appendChild(this.preview)
		        document.body.appendChild(this.box)

		        this.gradient_size=100

	        	this.list.item_selector_options = {item:'content-button',role:'option'}

		        this.on('palette items',e=>{
			        create_items(...(e.detail.reverse())).forEach(item=>this.list.appendChild(item))
			        this.list.update_items()
		        })

		        if(!this.url) this.palette = fxy.require('design/colors')

		        this.list.on('select',e=>{
		        	let item = e.detail.item
			        if(typeof timeout_id === 'number') timeout_id = window.clearTimeout(timeout_id)
			        window.requestAnimationFrame(_=>timeout_id=setTimeout(_=>this.on_selections(this.list.selected,item)))
		        })
	        }
	        get list(){ return this.query('content-menu') }
	        on_selections(selected,e){
	        	let colors = this.current_colors || []
		        let selected_colors = selected.map(item=>item.style.background)
		        colors = colors.filter(color=>selected_colors.includes(color))
		        for(let color of selected_colors) if(!colors.includes(color)) colors.push(color)
		        this.current_colors = colors
		        this.box.present(this.box_target || e)
		        gradient(this.preview,parseInt(this.gradient_size),colors)
	        }
	        get palette_options(){ return {number_of_items:3} }
        })

		//shared actions
	    function create_items(...items){
		    try{
			    return items.map(data=>{
				    let element = document.createElement('content-button')
				    element.style.background = data.value
				    element.kind = 'item'
				    element.title = data.name
				    element.setAttribute('role','option')
				    element.data = data
				    return element
			    })
		    }catch(e){
        		console.error(e)
		    }

	    }

	    function gradient(canvas,size,colors){
		    var ctx = canvas.getContext('2d')
		    let width = fxy.is.number(size) ? size:100
		    var g1 = ctx.createLinearGradient(0, 0, width, 0);

		    let increment = 1/colors.length
		    for(let i=0;i<colors.length;i++){
		    	let color = colors[i]
			    let position = i * increment
			    g1.addColorStop(position,color);
		    }
//		    g1.addColorStop(0,"magenta");
//		    g1.addColorStop(0.5,"yellow");
//		    g1.addColorStop(1,"black");
//		    ctx.fillStyle = g1;
//		    ctx.strokeStyle = "red";
//		    ctx.lineWidth = 10;
//		    ctx.fillRect(0, 0, 50, 50);
//		    ctx.strokeRect(0, 0, 50, 50);

//		    var g2 = ctx.createRadialGradient(350, 100, 0, 350, 100, 200);
//		    g2.addColorStop(0,"magenta");
//		    g2.addColorStop(0.5,"yellow");
//		    g2.addColorStop(1,"black");
//		    ctx.fillStyle = g2;
//		    ctx.fillRect(250,0,200,200);
//		    ctx.strokeRect(250,0,200,200);

		    var pattern = ctx.createPattern(canvas, "repeat");
		    ctx.fillStyle = pattern;
		    ctx.fillRect(0,0,width,width);
		    ctx.lineWidth = 20;
		    ctx.strokeStyle = g1;
		    ctx.strokeRect(0,0,width,width);
		    ctx.fill();
		    return pattern
	    }

    })(document)
</script>
