<template id="art-palette">
    <style>
        @import "/modules/wwi/component/design/host.css";
        :host{
	        position:relative;
	        max-height:100%;
	        height:100%;
        }
        [view]{
	        background:var(--dark);
	        max-height:100%;
	        overflow-y:auto;
	        width: 70vw;
        }
        content-menu{
	        display: inline-block;
	        width:calc(100% - 43px);
			height: 100%;
        }

	    content-button{
		    margin:5px;
		    position:relative;
	    }
	    [value]{
		    display:block;
		    position:relative;
		    background-color: white;
	    }
	    [gradient]{
		    height:60px;
		    width: 100%;
		    overflow: hidden;
	    }

	    [preview]{
		    position: relative;
		    box-sizing: border-box;
		    background-color: transparent;
		    border-radius: 7px;
	    }
        [gradient] [preview]:hover{
	        background-color: white;
        }
        [gradient] [preview]:active{
	        background-color: black;
        }

        content-menu content-button[aria-selected="true"]{
		    border:2px solid white;
	    }
	    [tools]{
		    top:0;
		    position:-webkit-sticky;
		    position: sticky;
		    max-height: 100vh;
	    }
        [tools] content-button{
	        background-color: rgba(255,255,255,0.5);
        }
        [tools] content-button[aria-selected="true"]{
	        background-color: rgba(255,255,255,0.75);
        }
    </style>
	<div view gui horizontal>
		<content-menu grid multi no-header id="colors">
			<div gradient slot="header">
				<canvas preview></canvas>
			</div>
		</content-menu>
		<div tools gui vertical>
			<content-button icon="drop_up" onclick="act.big_preview(event)"></content-button>
			<content-button icon="drop_down" aria-selected="true" onclick="act.small_preview(event)"></content-button>
		</div>
	</div>
</template>
<script>
    (function(doc){
        const ArtPalette = wwi.element(doc).extension(...window.components.art.mix('Palette'))
        ArtPalette(class extends ArtPalette.Element{
	        big_preview(event){
		        event.currentTarget.setAttribute('aria-selected','true')
		        event.currentTarget.nextElementSibling.setAttribute('aria-selected','false')
		        let width = this.gradient.clientWidth
		        this.gradient.style.height = width+'px'
		        this.resize_preview(width)
	        }
	        connected(){
	        	this.list.item_selector_options = {item:'content-button',role:'option'}
		        this.list.on('select',e=>{
			        let item = e.detail.item
			        this.on_selections(this.list.selected,item)
		        })
		        this.on('palette items',e=>{
			        create_items(...(e.detail.reverse())).forEach(item=>this.list.appendChild(item))
			        this.list.update_items()
		        })
		        this.palette()
				this.resize_preview()
		        app.on('resized',e=>this.resize_preview())
	        }
	        get gradient(){ return this.query('[gradient]') }
	        get list(){ return this.query('content-menu') }
	        on_selections(selected,e){
	        	let colors = this.current_colors || []
		        let selected_colors = selected.map(item=>item.style.background)
		        colors = colors.filter(color=>selected_colors.includes(color))
		        for(let color of selected_colors) if(!colors.includes(color)) colors.push(color)
		        this.current_colors = colors
		        gradient(this.preview,this.gradient_size,colors)
	        }
	        get palette_options(){ return {number_of_items:3} }
	        get preview(){ return this.query('[preview]') }
	        resize_preview(height){
		        this.gradient_size={ height:height || this.gradient.clientHeight, width:this.gradient.clientWidth }
		        let size = this.gradient_size
		        let preview = this.preview
		        preview.height = size.height
		        preview.width = size.width
		        if(this.current_colors) gradient(this.preview,size,this.current_colors)
	        }
	        small_preview(event){
		        event.currentTarget.setAttribute('aria-selected','true')
		        event.currentTarget.previousElementSibling.setAttribute('aria-selected','false')
		        this.gradient.style.height = ''
		        this.resize_preview(60)
	        }
        })

		//shared actions
	    function create_items(...items){
		    try{
			    return items.map(data=>{
				    let element = document.createElement('content-button')
				    element.style.background = data.value
				    element.kind = 'item'
				    element.title = data.name
				    element.setAttribute('role','option')
				    element.data = data
				    return element
			    })
		    }catch(e){
        		console.error(e)
		    }
	    }

	    function gradient(canvas,size,colors){
		    let ctx = canvas.getContext('2d')
		    let width = size.width
		    let g1 = ctx.createLinearGradient(0, 0, width, 0);
		    ctx.clearRect(0,0,width,size.height)

		    let increment = 1/colors.length
		    for(let i=0;i<colors.length;i++){
		    	let color = colors[i]
			    let position = i * increment
			    g1.addColorStop(position,color);
		    }
//		    g1.addColorStop(0,"magenta");
//		    g1.addColorStop(0.5,"yellow");
//		    g1.addColorStop(1,"black");
//		    ctx.fillStyle = g1;
//		    ctx.strokeStyle = "red";
//		    ctx.lineWidth = 10;
//		    ctx.fillRect(0, 0, 50, 50);
//		    ctx.strokeRect(0, 0, 50, 50);

//		    var g2 = ctx.createRadialGradient(350, 100, 0, 350, 100, 200);
//		    g2.addColorStop(0,"magenta");
//		    g2.addColorStop(0.5,"yellow");
//		    g2.addColorStop(1,"black");
//		    ctx.fillStyle = g2;
//		    ctx.fillRect(250,0,200,200);
//		    ctx.strokeRect(250,0,200,200);

		    let pattern = ctx.createPattern(canvas, "repeat");
		    ctx.fillStyle = pattern;
		    ctx.fillRect(0,0,width,size.height);
		    ctx.lineWidth = 20;
		    ctx.strokeStyle = g1;
		    ctx.strokeRect(0,0,width,size.height);
		    ctx.fill();
		    return pattern
	    }

    })(document)
</script>
