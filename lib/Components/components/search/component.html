<template id="search-component">
	<style>
		@import "/library/modules/wwi/component/design/host.css";
		:host{
			display: none;
			top:0;
			position: absolute;
			right:0;
			left:0;
			height:var(--height,40px);
			max-height: 100%;
			max-width: 100%;
		}

		:host([aria-expanded="true"]){
			display: block;
			z-index: 1000;
			animation:slide-down 250ms  forwards;
		}

		:host([aria-expanded="false"]){
			display: block;
			z-index: 1000;
			animation:slide-up 250ms forwards;
		}

		[view]{
			max-height:none;
			max-width: none;
			padding-left:10px;
			padding-right:10px;
			max-width: calc(100% - 20px);
		}

		input{
			display: inline-block;
			position: relative;
			border-radius: 100px;
			border:none;
			-webkit-appearance: none;
			appearance:none;
			background-color: white;
			box-sizing: border-box;
			padding:5px 18px 5px 18px;
			max-width: calc(100% - 36px);
			max-height: calc(100% - 100px);
			width:50%;
			margin:0 auto;
			font-size:var(--font-size,16px);
			outline: none;
			box-shadow: none;
			transition:box-shadow 180ms ease;
			will-change:box-shadow;
			left:var(--input-left,0);
		}

		input:focus{
			box-shadow:0 0 1px 2px var(--color,var(--tangerine));
		}
		[buttons]{
			display: inline-block;
			position: absolute;
			right:10px;
			height:100%;
		}

		@keyframes slide-down{
			0%{
				transform:translate3d(0,-100%,0);
			}
			100% {
				transform: translate3d(0, 0, 0);
			}
		}
		@keyframes slide-up{
			0%{
				transform:translate3d(0,0,0);
			}
			100% {
				transform: translate3d(0, -100%, 0);
			}
		}
	</style>
	<div view gui horizontal center-center>
		<input tabindex="0" type="search" placeholder="Search..." aria-label="Search">
		<div buttons gui horizontal center-center>
			<slot name="clear-button"></slot>
			<slot name="close-button"></slot>
		</div>
	</div>

</template>
<script>
	(function(doc){
		let extension = [{module:'behavior', name:'Timeout'}]
		const SearchComponent = wwi.element(doc).extension(...extension)

		SearchComponent(class extends SearchComponent.Element{

			constructor(){
				super('routes',{
					expanded(value){
						if(value === null){
							this.setAttribute('aria-expanded','false')
							this.input.setAttribute('tabindex','-1')
							this.timeout(()=>this.style.display='none',300)
							this.dispatch('done')
						}else{
							this.style.display=''
							this.setAttribute('aria-expanded','true')
							this.input.setAttribute('tabindex','0')
							this.input.focus()
							this.dispatch('searching')
						}
					},
					placeholder(value){
						if(value !== null) this.input.setAttribute('placeholder',value)
					},
					label(value){
						if(value !== null) this.input.setAttribute('aria-label',value)
					}
				})
			}
			get button(){ return get_button(this) }
			set button(value){ return set_button(this,value)}
			get close_button(){ return this.slots['close-button'].item }
			connected(){
				this.input.onkeyup = e => !this.empty ? this.timeout(()=>this.dispatch('search',this.keywords)):false
				this.input.onsearch = e => {
					this.timeout(()=>this.dispatch('search',this.keywords))
				}
				this.query('slot[name="close-button"]').addEventListener('slotchange',e=>{
					fxy.when('navigator-clear','navigator-close').then(_=>{
						this.close_button.on('clear',e=>this.expanded=false)
						this.close_button.on('close',e=>this.expanded=false)
					})
				},false)
			}
			get empty(){ return this.value.length <= 0}
			get input(){ return this.query('input') }
			get keywords(){ return !this.empty ? this.value.split(' ').map(word=>word.trim().toLowerCase()).filter(word=>word.length):[] }
			toggle(){
				if(this.expanded) this.expanded = false
				else this.expanded = true
				return this
			}
			get value(){ return this.input.value.trim() }


		})
		//shared actions
		function get_button(element){
			let symbol = Symbol.for('search button')
			if(symbol in element) return element[symbol]
			return null
		}
		function set_button(element,button){
			let symbol = Symbol.for('search button')
			fxy.when('navigator-search').then(_=>{
				button.on.search = e => element.toggle()
			})
			return element[symbol] = button
		}


	})(document)
</script>
