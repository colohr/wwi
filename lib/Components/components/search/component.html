<template id="search-component">
	<style>
		@import "components/search/design/search.css";
		:host{
			display: none;
			top:0;
			position: absolute;
			right:0;
			left:0;
			height:var(--height,40px);
			max-height: 100%;
			max-width: 100%;
		}

		:host([aria-expanded="true"]){
			display: block;
			z-index: 1000;
			animation:slide-down 250ms  forwards;
		}

		:host([aria-expanded="false"]){
			display: block;
			z-index: 1000;
			animation:slide-up 250ms forwards;
		}

		[view]{
			max-height:none;
			padding-left:10px;
			padding-right:10px;
			max-width: calc(100% - 20px);
		}

		input:focus{
			box-shadow:0 0 1px 2px var(--color,var(--tangerine));
		}
		[buttons]{
			display: inline-block;
			position: absolute;
			right:10px;
			height:100%;
		}

		@keyframes slide-down{
			0%{
				transform:translate3d(0,-100%,0);
			}
			100% {
				transform: translate3d(0, 0, 0);
			}
		}
		@keyframes slide-up{
			0%{
				transform:translate3d(0,0,0);
			}
			100% {
				transform: translate3d(0, -100%, 0);
			}
		}


	</style>
	<div view gui horizontal center-center>
		<input aria-autocomplete="list"
		       aria-expanded="false"
		       aria-labelledby="search-input-1"
		       aria-owns="search-results-1"
		       aria-label="Search"
		       autocomplete="off"
		       dir="auto"
		       id="search-input-1"
		       placeholder="Search..."
		       role="combobox"
		       spellcheck="false"
		       tabindex="0"
		       type="search">

		<div buttons gui horizontal center-center>
			<slot name="clear-button"></slot>
			<slot name="close-button"></slot>
		</div>
	</div>

</template>
<script>
	(function(doc){
		let extension = [{module:'behavior', name:'Timeout'}]
		const SearchComponent = wwi.element(doc).extension(...extension)
		SearchComponent(class extends SearchComponent.Element{
			constructor(){
				super('routes',{
					expanded(value){ return this.expand(value) },
					placeholder(value){
						if(value !== null) this.input.setAttribute('placeholder',value)
					},
					label(value){
						if(value !== null) this.input.setAttribute('aria-label',value)
					}
				})
			}
			get button(){ return get_button(this) }
			set button(value){ return set_button(this,value)}
			get close_button(){ return this.slots['close-button'].item }
			connect(controller){}
			connected(){
				this.input.onkeyup = e => !this.empty ? this.timeout(()=>this.dispatch('search',this.keywords)):false
				this.input.onsearch = e => this.timeout(()=>this.dispatch('search',this.keywords))
				this.query('slot[name="close-button"]').addEventListener('slotchange',e=>{
					fxy.when('navigator-clear','navigator-close').then(_=>{
						this.close_button.on('clear',e=>this.expanded=false)
						this.close_button.on('close',e=>this.expanded=false)
					})
				},false)
			}
			get empty(){ return this.value.length <= 0}
			expand(value){
				if(value === null){
					this.setAttribute('aria-expanded','false')
					this.input.setAttribute('tabindex','-1')
					this.timeout(()=>this.style.display='none',300)
					this.dispatch('done')
					this.results.hide()
				}
				else{
					this.style.display=''
					this.setAttribute('aria-expanded','true')
					this.input.setAttribute('tabindex','0')
					this.input.focus()
					this.dispatch('searching')
					this.timeout(()=>this.results.present(this),350)
				}
				return this
			}
			get input(){ return this.query('input') }
			get keywords(){ return !this.empty ? this.value.split(' ').map(word=>word.trim().toLowerCase()).filter(word=>word.length):[] }
			toggle(){
				if(this.expanded) this.expanded = false
				else this.expanded = true
				return this
			}
			get value(){ return this.input.value.trim() }
		})
		//shared actions
		function get_button(element){
			let symbol = Symbol.for('search button')
			if(symbol in element) return element[symbol]
			return null
		}
		function set_button(element,button){
			let symbol = Symbol.for('search button')
			fxy.when('navigator-search').then(_=>{
				button.on.search = e => element.toggle()
			})
			return element[symbol] = button
		}
	})(document)
</script>
